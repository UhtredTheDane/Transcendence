{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Pong</title>
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
	<link rel="stylesheet" href="{% static 'css/game.css' %}">
</head>
<body>
    <canvas id="gameCanvas" width="800" height="400"></canvas>
	<button id="pauseButton" onclick="togglePauseGame()">Pause</button>
	<button><a href="/">Home</button>
    <script>
        const gameId = '{{ game_id }}';
        const playerRole = '{{ player_role }}';
        
        const socket = new WebSocket(`ws://${window.location.host}/ws/game/${gameId}/`);
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        
        const PADDLE_HEIGHT = 60;
        const CANVAS_HEIGHT = canvas.height;
        const CANVAS_WIDTH = canvas.width;
        
        let playerY = 170;
        let opponentY = 170;
		let playerScore = 0;
		let opponentScore = 0;
        let ball = { x: 400, y: 200, dx: 3, dy: 3 };
        let isSocketOpen = false;
        let isBallMover = false;
		let isPaused = false;
		let isGameEnded = false;

        socket.onopen = () => {
            console.log("Connecté au WebSocket du jeu");
            isSocketOpen = true;
        };

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            //if (data.type !== "update_ball_position" && data.type !== "update_position")
			//	console.log("Message reçu :", data);
			if (data.type === "update_position") {
				if (data.player === "player1") {
					if (playerRole === "player1") playerY = data.position;
                    else opponentY = data.position;
                } else {
					if (playerRole === "player2") playerY = data.position;
                    else opponentY = data.position;
                }
            } else if (data.type === "update_ball_position") {
				ball.x = data.ball_x;
                ball.y = data.ball_y;
            } else if (data.type === "update_game_score") {
				playerScore = data.score_player1;
				opponentScore = data.score_player2;
			} else if (data.type === "update_pause") {
				isPaused = data.is_paused;
				if (isPaused) {
					document.getElementById("pauseButton").innerText = "Play";
				} else {
					document.getElementById("pauseButton").innerText = "Pause";
				}
			} else if (data.type === "game_state") {
                playerY = data.player1_y;
                opponentY = data.player2_y;
                ball.x = data.ball_x;
                ball.y = data.ball_y;
                isBallMover = (playerRole === "player1");
            } else if (data.type === "game_over") {
				document.getElementById("pauseButton").display = "none";
				//alert(playerRole == getWinner() ? "Vous avez gagné !" : "Vous avez perdu !");
				//setTimeout(() => {
					window.location.href = "/";
				//}, 4000);
			}
            drawGame();
        };

		function getWinner() {
			if (playerScore > opponentScore) return "player1";
			else if (playerScore < opponentScore) return "player2";
		}

        socket.onerror = (error) => {
            console.error("WebSocket Erreur :", error);
        };

        socket.onclose = () => {
            console.log("WebSocket fermé");
            isSocketOpen = false;
        };

		function togglePauseGame() {
			isPaused = !isPaused;
			if (isGameEnded || !isSocketOpen || socket.readyState !== WebSocket.OPEN) return;
				socket.send(JSON.stringify({ type: "pause", is_paused: isPaused }));
		}

        function sendMove(position) {
            if (isGameEnded || !isSocketOpen || socket.readyState !== WebSocket.OPEN) return;
            socket.send(JSON.stringify({ type: "move", position: position }));
        }

        function sendBallPosition() {
            if (isGameEnded || !isSocketOpen || socket.readyState !== WebSocket.OPEN) return;
            socket.send(JSON.stringify({ type: "ball", ball_x: ball.x, ball_y: ball.y }));
        }

		function sendUpdateGameScore() {
			if (isGameEnded || !isSocketOpen || socket.readyState !== WebSocket.OPEN) return;
			socket.send(JSON.stringify({ type: "score", score_player1: playerScore, score_player2: opponentScore }));
		}

		function endGame() {
			isGameEnded = true;
			if (isSocketOpen && socket.readyState === WebSocket.OPEN) {
				socket.send(JSON.stringify({ type: "end", score_player1: playerScore, score_player2: opponentScore }));
			}
			document.getElementById("pauseButton").display = "none";
			alert(playerRole == getWinner() ? "Vous avez gagné !" : "Vous avez perdu !");
			window.location.href = "/";
		}

        document.addEventListener("keydown", function(event) {
			if (isPaused || isGameEnded) return;
			if (event.key === "ArrowUp" || event.key === "w" || event.key === "z") {
                sendMove(Math.max(0, playerY - 10));
            }
            if (event.key === "ArrowDown" || event.key === "s") {
				sendMove(Math.min(CANVAS_HEIGHT - PADDLE_HEIGHT, playerY + 10));
            }
        });

		function resetBall() {
			ball.x = CANVAS_WIDTH / 2;
			ball.y = CANVAS_HEIGHT / 2;
			ball.dx = (Math.random() > 0.5 ? 1 : -1) * 3;
			ball.dy = (Math.random() > 0.5 ? 1 : -1) * 3;
		}		

        function updateBall() {
			if (isPaused || isGameEnded) return;
			if (isBallMover) {
				ball.x += ball.dx;
				ball.y += ball.dy;
		
				// Collision avec le haut/bas
				if (ball.y <= 0 || ball.y >= CANVAS_HEIGHT) {
					ball.dy *= -1;
				}
		
				// Collision avec les raquettes
				if ((ball.x <= 30 && ball.y >= playerY && ball.y <= playerY + PADDLE_HEIGHT) ||
					(ball.x >= 770 && ball.y >= opponentY && ball.y <= opponentY + PADDLE_HEIGHT)) {
					ball.dx *= -1;
				}

				if (ball.x <= 0 || ball.x >= CANVAS_WIDTH) {
					if (ball.x <= 0) opponentScore++;
					else playerScore++;
					
					resetBall();
					sendUpdateGameScore();

					if (playerScore >= 2 || opponentScore >= 2)
						endGame();
				}
				sendBallPosition();
			}
		}

        function drawGame() {
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            ctx.fillStyle = "white";
            
			ctx.fillText(playerScore, 100, 100);
			ctx.fillText(opponentScore, 700, 100);

            if (playerRole === "player1") {
                ctx.fillRect(20, playerY, 10, PADDLE_HEIGHT); // Joueur à gauche
                ctx.fillRect(770, opponentY, 10, PADDLE_HEIGHT); // Adversaire à droite
            } else {
                ctx.fillRect(770, playerY, 10, PADDLE_HEIGHT); // Joueur à droite
                ctx.fillRect(20, opponentY, 10, PADDLE_HEIGHT); // Adversaire à gauche
            }
            
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, 5, 0, Math.PI * 2);
            ctx.fill();
        }

        setInterval(() => {
            updateBall();
            drawGame();
        }, 16);
    </script>
</body>
</html>
